@using Services.Users
@using Services.Posts
@using Services.Tags
@using OPC5_BlogApp.Data.Models
@using System.ComponentModel.DataAnnotations
@using System.ComponentModel.DataAnnotations.Schema
@inject IUserService userService
@inject IPostService postService
@inject ITagService tagService
@rendermode InteractiveServer

<form class="dashboard-poster">
    <div>
        <div class="form-group">
            <label for="postContent" style="font-weight: bold;">Post Content</label>
            <textarea placeholder="Vad är det som händer?" id="postContent" class=" dashboard-poster-input" @bind="newPost.PostData"></textarea>
        </div>
        <hr />
        <button style="margin-top: 15px;" type="submit" class="btn btn-primary dashboard-poster-button" @onclick="HandlePost">Gör ett inlägg</button>

    </div>
</form>

<style>
    .dashboard-poster {
        width: 100%;
        background-color: black;
        border: 1px solid white;
        padding: 10px;

        border-top-left-radius: 5px;
        border-top-right-radius: 5px;

        /*margin-bottom: 5%;*/
    }

    .dashboard-poster-input {
        background-color: transparent;
        border: none;
        width: 90%;
        color: white;
        margin: 20px;
        resize: none;

        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .dashboard-poster-input:hover {
        border: none;
        background-color: transparent;
    }

    .dashboard-poster-input:focus {
        border: none;
        outline: 0;
    }

    .dashboard-poster-button {
        margin-left: 77%;
        border-radius: 20px;
        font-weight: bold;
    }
</style>

@code {
    private User currentUser = new User();
    private Post newPost = new Post();

    private async Task HandlePost()
    {
        /* Check if logged in, if not then redirect! */
        if (string.IsNullOrWhiteSpace(newPost.PostData))
        {
            Console.WriteLine("Returning since no message was entered.");
            return;
        }

        try
        {

            if (newPost.PostData.TrimStart().StartsWith("#"))
            {
                await postService.AddPost(newPost);
                // If the post starts with a hashtag, add a tag
                string[] words = newPost.PostData.Split(' ');
                string tagName = words[0].TrimStart('#');

                Tag tag = new Tag();
                tag.TagName = tagName;
                tag.PostId = newPost.PostId;

                // Add the tag to the database
                await tagService.AddTag(tag);
                Console.WriteLine("Tag added successfully.");
            }else if (!newPost.PostData.TrimStart().StartsWith("#"))
            {
                // Add the post to the database
                await postService.AddPost(newPost);
            }

            // Reset the newPost object for the next post
            newPost = new Post();

            // Trigger UI refresh
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error handling post: {ex.Message}");
            // Handle any exceptions, such as displaying an error message to the user
        }
    }
}

